---
title: "DSAN 5100 Final Project - Time Series Analysis"
author: "Alison Manna"
format: 
  html:
    embed-resources: true
toc: true
---

## The Data: Mortality from Maternal Hypertensive Disorders
Link: https://vizhub.healthdata.org/gbd-results/, accessed via https://ourworldindata.org/maternal-mortality

```{r, echo=FALSE,message=FALSE,warning=FALSE}
library(tidyverse)
library(ggplot2)
library(forecast)
library(astsa) 
library(xts)
library(tseries)
library(fpp2)
library(fma)
library(lubridate)
library(tidyverse)
library(TSstudio)
library(quantmod)
library(tidyquant)
library(plotly)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(dplyr)
library(patchwork)
library(kableExtra)
```

```{r, include=FALSE}
# Read in data
ihme <- read.csv("time_series/data/IHME-2023.csv")
# select relevant columns, order by year
ihme <- ihme |> select(year, val)

# reformat year, fix datatypes
# ihme$year <- as.Date(paste0(ihme$year, "-01-01"))
# ihme$year <- format(ihme$year, "%Y")
ihme$year <- as.numeric(ihme$year)

# order
ihme <- ihme |> arrange(year) |> rename(mortality = val)
head(ihme)
```

```{r}
plot <- ggplot(ihme, aes(year, mortality)) + 
  geom_point(color = "purple", size = 0.6) +
  geom_line(color = "purple", size = 0.5) + 
  labs(title = "Maternal Mortality Ratio from Hypertensive Disorders in the United States, 1980-2023",
    subtitle = "Deaths per 100,000 Live Births Due to Maternal Hypertensive Disorders",
    x = "Year",
    y = "Mortality Ratio") +
  theme_minimal() + 
  theme(panel.grid.major = element_blank(),
    panel.grid.minor = element_blank())

ggplotly(plot)

```

conversion to TS component
```{r}
ihme_ts <- ts(ihme$mortality, start = 1980, frequency = 1)
```

## Decomposition

```{r}
decomposed = decompose(ihme_ts)
autoplot(decomposed)

# library(seasonal)
# ihme_ts %>% seas(x11="") -> fit
# autoplot(fit) +
#   ggtitle("X11 decomposition")
```

since we can't decompose annual data, we perform a moving average calculation to extract the trend component.

```{r}
# centered moving average (NA at edges is expected)
trend_mortality <- ma(ihme_ts, order = 6, centre = TRUE)

plot_ly(x = ~time(ihme_ts)) |>
  add_lines(y = ~as.numeric(ihme_ts), name = "Original") |>
  add_lines(y = ~as.numeric(trend_mortality), name = "Trend (MA)", line = list(dash = "dash")) |>
  layout(title = "Maternal Mortality: Original vs Trend", xaxis = list(title = "Year"), yaxis = list(title = "Mortality Ratio"))
```

## Lag Plots
```{r}
gglagplot(ihme_ts, do.lines=FALSE) +
  xlab("Lags") +
  ylab("Yt") +
  ggtitle("Lag Plot for Maternal Hypertension Mortality")
```

## ACF and PACF

```{r, warning=FALSE, message=FALSE}
ihme_acf <- ggAcf(ihme_ts, main = "ACF of Maternal Hypertension Mortality")
ihme_acf

# ihme_pacf <- ggPacf(ihme_ts, main = "PACF of Maternal Hypertension Mortality")

# grid.arrange(ihme_acf, ihme_pacf, nrow = 2)
```

ACF: gradual decay, non-stationary (has a trend)

## ADF test

```{r}
adf.test(ihme_ts)
```

High p-value (0.8508): Fail to reject the null hypothesis, the series is non-stationary

the results from the ADF test support my observations in the ACF plot

## Differencing

```{r}
diff_ihme <- diff(ihme_ts)

# First-order differencing
diff_1 <- diff(ts_indeed)

# Second-order differencing
diff_2 <- diff(ts_indeed, differences = 2)

# Plot original vs. differenced
acf_plot_1 <- ggAcf(ihme_ts,50) +
  ggtitle("ACF of Original Series") +
  theme_minimal()

acf_plot_2 <- ggAcf(diff_ihme,50) +
  ggtitle("ACF of Differenced Series") +
  theme_minimal()

# Display both ACF plots side by side
acf_plot_1 / acf_plot_2
```

differencing signiciantly reduces the autocorrelation across all lags, therefore it is necessary. this is sufficient and the data does not need second-order differencing.

## Log Transformation

```{r}
ihme$log_mortality <- log(ihme$mortality)

plot_ly(ihme, x = ~as.Date(year)) |>
  add_lines(y = ~mortality, name = 'Original Prices', line = list(color = 'blue')) %>%
  add_lines(y = ~log_mortality, name = 'Log-Transformed', line = list(color = 'red')) %>%
  layout(title = "Original vs Log-Transformed Maternal Hypertension Mortality",
         xaxis = list(title = "Date"),
         yaxis = list(title = "Price"))
```

```{r}
library(patchwork)

ihme$log_mortality <- log(ihme$mortality)
log_ihme_ts <- ts(ihme$log_mortality, start = 1980, frequency = 1)

# Difference the Data
diff_ihme <- diff(ihme_ts)
diff_log_ihme <- diff(log_ihme_ts)

# Plots for differenced data
p1 <- ggplot() +
  geom_line(aes(x = time(diff_ihme), y = diff_ihme), size = 0.9, color = "blue") +
  labs(title = "Differenced Mortality",
       x = "Time",
       y = "Differenced Mortality Ratio") +
  theme_minimal()

p2 <- ggplot() +
  geom_line(aes(x = time(diff_log_ihme), y = diff_log_ihme), size = 0.9, color = "red") +
  labs(title = "Differenced Log-Transformed Mortality",
       x = "Time",
       y = "Differenced Log Mortality Ratio") +
  theme_minimal()

# Combine plots
p1 / p2
```

the original series did not visually show extreme skew, outliers, or multiplicative relationship, and the plot above confirms that a log transformation is not necessary for this data.

## ACF/PACF to identify ARIMA orders

```{r, warning=FALSE, message=FALSE}
ihme_acf <- ggAcf(ihme_ts, main = "ACF of Maternal Hypertension Mortality")
ihme_acf

ihme_pacf <- ggPacf(ihme_ts, main = "PACF of Maternal Hypertension Mortality")

grid.arrange(ihme_acf, ihme_pacf, nrow = 2)
```

d = 1, test 0 too
q = 0:3 (no further to maintain parsimony)
p = 1, 0 too

## Manual ARIMA Parameter search

```{r}
# adapted from Gamage, P. (2026). Applied Time Series for Data Science.
# Parameter ranges
p_range <- 0:1
d_range <- 0:1
q_range <- 0:3

# Create matrix to store results
n_combinations <- length(p_range) * length(d_range) * length(q_range)
results_matrix <- matrix(NA, nrow = n_combinations, ncol = 6)

i <- 1
# Loop through combinations of ARIMA model parameters
for (q in q_range) {
  for (p in p_range) {
    for (d in d_range) {

      # Fit ARIMA model with specified (p,d,q)
      model <- Arima(ihme_ts, order = c(p, d, q), include.drift = TRUE)

      # Store model parameters and AIC/BIC/AICc values in matrix
      results_matrix[i, ] <- c(p, d, q, model$aic, model$bic, model$aicc)

      # Increment row index
      i <- i + 1
    }
  }
}

# Convert matrix to data frame
results_df <- as.data.frame(results_matrix)
colnames(results_df) <- c("p", "d", "q", "AIC", "BIC", "AICc")

# Find row with min AIC
highlight_row <- which.min(results_df$AIC)

# Generate kable table with highlighting for the row with the lowest AIC
knitr::kable(results_df, align = 'c', caption = "Comparison of ARIMA Models") |>
  kable_styling(full_width = FALSE, position = "center") |>
  row_spec(highlight_row, bold = TRUE, background = "#FFFF99")
```

returned ARIMA(1,1,3)

## Auto.arima()

```{r}
auto_model <- auto.arima(ihme_ts)
auto_model
```

returned ARIMA(0,1,0), random walk

## Model Diagnostics
```{r}
set.seed(5100)
# ARIMA(1,1,3)
model_output <- capture.output(sarima(ihme_ts, 1, 1, 3))

# capture coefficient details
start_line <- grep("Coefficients", model_output)
end_line <- length(model_output)
cat(model_output[start_line:end_line], sep = "\n")
```

```{r}
set.seed(5100)
model_output <- capture.output(sarima(ihme_ts, 0, 1, 0))

# capture coefficient details
start_line <- grep("Coefficients", model_output)
end_line <- length(model_output)
cat(model_output[start_line:end_line], sep = "\n")
```

The Residual Plots for both ARIMA(3,1,2) and ARIMA(0,1,0) show fairly consistent fluctuation around zero, meaning the residuals are likely pretty close to stationary, which is an indication of strong-fitting models.

The ACF of the residuals of both ARIMA models has no significant autocorrelations.

The Q-Q Plot of both models shows the residuals closely following a normal distribution, with only slight deviations at the tails. 

The Ljung-Box Test p-values are all above the 0.05 significance level for both models, which means there is little of autocorrelation remaining. The p-values are just slighly higher on average in the ARIMA(0,1,0) model compared to the ARIMA(1,1,3) model.

In the ARIMA(1,1,3) model, the ar1 and ma2 coefficients are insignificant, with p-values of 0.1126 and 0.4432, respectively. The ARIMA(0,1,0) model is much simpler and does not have variables/predictors.

<!-- I will proceed with ARIMA(0,1,0). Even though both models perform similarly, ARIMA(0,1,0) is more parsimonious than ARIMA(1,1,3), demonstrates slightly more significance in the LB test, and has no insignificant coefficients. -->

ARIMA(0,1,0) is more parsimonious than ARIMA(1,1,3) and demonstrates slightly more significance in the LB test, but it is a very simplistic model. We ran model diagnostics on some other, higher order ARIMA models and the one below produced equally strong diagnostic plots.

```{r}
set.seed(5100)
# try: ARIMA(2,1,1)
model_output <- capture.output(sarima(ihme_ts, 2, 1, 2))

# capture coefficient details
start_line <- grep("Coefficients", model_output)
end_line <- length(model_output)
cat(model_output[start_line:end_line], sep = "\n")
```

**ARIMA(2,1,1)** produces very similar diagnostic plots, but also comes with the added addvantages of a lower AIC value and all significant coefficients. Therefore, we will proceed with this model. 

## Benchmark Error and Forecast Comparison 

```{r, warning=FALSE}
# Fit ARIMA model & show summary
fit <- Arima(ihme_ts, order = c(2,1,2), include.drift = FALSE)
# summary(fit)

acc <- accuracy(fit)
mae <- acc[1, "MAE"]
mse <- (acc[1, "RMSE"])^2  

# mean fit
mean_fit <- meanf(ihme_ts)
mean_acc <- accuracy(mean_fit)
mean_mae <- mean_acc[1, "MAE"]
mean_mse <- (mean_acc[1, "RMSE"])^2

# naive fit
naive_fit <- naive(ihme_ts)
naive_acc <- accuracy(naive_fit)
naive_mae <- naive_acc[1, "MAE"]
naive_mse <- (naive_acc[1, "RMSE"])^2

# drift fit
drift_fit <- rwf(ihme_ts)
drift_acc <- accuracy(drift_fit)
drift_mae <- drift_acc[1, "MAE"]
drift_mse <- (drift_acc[1, "RMSE"])^2

# Results table
results <- data.frame(
  Model = c("ARIMA(0,1,0)", "Mean", "Naive", "Drift"),
  MAE = c(mae, mean_mae, naive_mae, drift_mae),
  MSE = c(mse, mean_mse, naive_mse, drift_mse)
)

# Display table
knitr::kable(results, digits = 3, caption = "MAE and MSE for Each Model")
```

```{r}
# Generate forecasts
mean_forecast <- meanf(ihme_ts, h = 10)
naive_forecast <- naive(ihme_ts, h = 10)
drift_forecast <- rwf(ihme_ts, drift = TRUE, h = 10)
arima_forecast <- forecast(fit, h = 10)

# Convert forecasts to data frames
mean_df <- data.frame(Date = time(mean_forecast$mean), Mean = as.numeric(mean_forecast$mean))
naive_df <- data.frame(Date = time(naive_forecast$mean), Naive = as.numeric(naive_forecast$mean))
drift_df <- data.frame(Date = time(drift_forecast$mean), Drift = as.numeric(drift_forecast$mean))
arima_df <- data.frame(Date = time(arima_forecast$mean), ARIMA_Fit = as.numeric(arima_forecast$mean))

```
```{r}
# Original data
ihme_ts_df <- data.frame(Date = time(ihme_ts), Price = as.numeric(ihme_ts))

# Create Plotly plot
plot_ly() |>
  add_lines(data = ihme_ts_df, x = ~Date, y = ~Price, name = 'Original Data', line = list(color = 'black')) |>
  add_lines(data = mean_df, x = ~Date, y = ~Mean, name = 'Mean Forecast', line = list(color = 'blue')) |>
  add_lines(data = naive_df, x = ~Date, y = ~Naive, name = 'NaÃ¯ve Forecast', line = list(color = 'red')) |>
  add_lines(data = drift_df, x = ~Date, y = ~Drift, name = 'Drift Forecast', line = list(color = 'green')) |>
  add_lines(data = arima_df, x = ~Date, y = ~ARIMA_Fit, name = 'ARIMA Fit', line = list(color = 'purple')) |>
  layout(title = 'Maternal Hypertension Mortality Ratio Forecast',
         xaxis = list(title = 'Date'),
         yaxis = list(title = 'Ratio'),
         legend = list(title = list(text = 'Forecast Methods')))
```

It is clear that the ARIMA model provides a better fit and forecast than the simple baseline models.

## Final ARIMA(2,1,2) Forecast

```{r}
forecast_result <- forecast(fit, h = 10)

# Plot
autoplot(forecast_result) +
  labs(title = "ARIMA(0,1,0) Forecast",
       x = "Time",
       y = "Predicted Price") +
  theme_bw()
```

<!-- ```{r}
who <- read.csv("time_series/data/maternal-mortality-rate-who-mdb.csv")

who <- who |> 
  rename(Deaths = Age.standardized.deaths.from.maternal.conditions.in.both.sexes.in.those.aged.all.ages.per.100.000.people) |> 
  select(Year, Deaths) |>
  arrange(Year)

head(who)

plot <- ggplot(who, aes(Year, Deaths)) + 
  geom_line(color = "purple", size = 0.5) + 
  labs(title = "Age-Standardized Deaths from Maternal Conditions in the United States, 1950-2022",
    x = "Year",
    y = "Mortality Rate") +
  theme_minimal() + 
  theme(panel.grid.major = element_blank(),
    panel.grid.minor = element_blank())

ggplotly(plot)
``` 
m-->